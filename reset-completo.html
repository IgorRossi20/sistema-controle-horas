<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Completo - Controle de Horas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 800px; margin-top: 2rem; }
        .btn-danger { background: linear-gradient(45deg, #dc3545, #c82333); }
        .btn-success { background: linear-gradient(45deg, #28a745, #20c997); }
        .alert { border-radius: 10px; }
        pre { background: #f8f9fa; padding: 1rem; border-radius: 5px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-4">
            <h1>🔄 Reset Completo do Sistema</h1>
            <p class="lead">Limpar TODOS os dados e começar do zero</p>
        </div>

        <div class="alert alert-danger">
            <h3>⚠️ RESET TOTAL DO SISTEMA</h3>
            <p><strong>Esta ferramenta irá:</strong></p>
            <ul>
                <li>🗑️ Excluir TODOS os projetos</li>
                <li>🗑️ Excluir TODOS os registros de tempo</li>
                <li>🗑️ Excluir TODOS os clientes</li>
                <li>🗑️ Limpar dados do usuário</li>
                <li>🔄 Reinicializar o sistema completamente</li>
            </ul>
            <p class="mb-0"><strong>⚠️ ATENÇÃO: Esta ação é IRREVERSÍVEL!</strong></p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>📊 Dados Atuais</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-info w-100" onclick="verificarDados()">🔍 Verificar Dados Atuais</button>
                        <div id="dadosAtuais" class="mt-3"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>🔄 Reset Completo</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-danger w-100 mb-3" onclick="resetCompleto()">🗑️ RESET TOTAL</button>
                        <button class="btn btn-success w-100" onclick="recarregarApp()">🔄 Recarregar App</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="resultado" class="alert" style="display: none; margin-top: 2rem;"></div>
    </div>

    <script>
        // Chaves do localStorage
        const chaves = {
            clients: 'controle_horas_clients',
            projects: 'controle_horas_projects',
            timeEntries: 'controle_horas_time_entries',
            user: 'controle_horas_user'
        };

        function verificarDados() {
            const div = document.getElementById('dadosAtuais');
            let html = '<h6>📊 Status Atual:</h6>';
            let totalItens = 0;

            Object.entries(chaves).forEach(([nome, chave]) => {
                const dados = localStorage.getItem(chave);
                if (dados) {
                    try {
                        const parsed = JSON.parse(dados);
                        const count = Array.isArray(parsed) ? parsed.length : 1;
                        totalItens += count;
                        html += `<p><strong>${nome}:</strong> ${count} itens</p>`;
                        
                        if (count > 0 && count <= 3) {
                            html += `<pre>${JSON.stringify(parsed, null, 2).substring(0, 150)}...</pre>`;
                        }
                    } catch (e) {
                        html += `<p><strong>${nome}:</strong> Dados corrompidos</p>`;
                        totalItens += 1;
                    }
                } else {
                    html += `<p><strong>${nome}:</strong> Vazio</p>`;
                }
            });

            // Verificar outras chaves relacionadas
            const todasChaves = Object.keys(localStorage);
            const chavesRelacionadas = todasChaves.filter(chave => 
                chave.includes('controle_horas') || 
                chave.includes('time_entries') || 
                chave.includes('projects')
            );

            if (chavesRelacionadas.length > Object.keys(chaves).length) {
                html += `<p><strong>⚠️ Chaves extras encontradas:</strong> ${chavesRelacionadas.length - Object.keys(chaves).length}</p>`;
            }

            html += `<hr><p><strong>📊 Total de itens:</strong> ${totalItens}</p>`;
            
            if (totalItens === 0) {
                html += '<div class="alert alert-success">✅ Sistema já está limpo!</div>';
            } else {
                html += '<div class="alert alert-warning">⚠️ Dados encontrados - Reset necessário</div>';
            }

            div.innerHTML = html;
        }

        function resetCompleto() {
            if (!confirm('🚨 CONFIRMAÇÃO FINAL\n\nTem ABSOLUTA CERTEZA que deseja EXCLUIR TODOS OS DADOS?\n\n• Todos os projetos serão perdidos\n• Todos os registros de tempo serão perdidos\n• Todos os clientes serão perdidos\n\nEsta ação é IRREVERSÍVEL!')) {
                return;
            }

            if (!confirm('🔴 ÚLTIMA CONFIRMAÇÃO\n\nDigite OK para confirmar o RESET TOTAL:') || !prompt('Digite "RESET" para confirmar:')?.toUpperCase().includes('RESET')) {
                mostrarResultado('❌ Reset cancelado pelo usuário.', 'warning');
                return;
            }

            let itensRemovidos = 0;
            let chavesLimpas = [];

            // Contar itens antes de remover
            Object.entries(chaves).forEach(([nome, chave]) => {
                const dados = localStorage.getItem(chave);
                if (dados) {
                    try {
                        const parsed = JSON.parse(dados);
                        const count = Array.isArray(parsed) ? parsed.length : 1;
                        itensRemovidos += count;
                        chavesLimpas.push(`${nome}: ${count} itens`);
                    } catch (e) {
                        itensRemovidos += 1;
                        chavesLimpas.push(`${nome}: dados corrompidos`);
                    }
                }
            });

            // Limpar TODAS as chaves relacionadas
            const todasChaves = Object.keys(localStorage);
            todasChaves.forEach(chave => {
                if (chave.includes('controle_horas') || 
                    chave.includes('time_entries') || 
                    chave.includes('projects') ||
                    chave.includes('client')) {
                    localStorage.removeItem(chave);
                }
            });

            // Reinicializar com arrays vazios
            Object.values(chaves).forEach(chave => {
                localStorage.setItem(chave, JSON.stringify([]));
            });

            // Limpar cache do navegador relacionado
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        if (name.includes('controle') || name.includes('horas')) {
                            caches.delete(name);
                        }
                    });
                });
            }

            const mensagem = `🎉 RESET COMPLETO REALIZADO!\n\n📊 Resumo:\n• ${itensRemovidos} itens removidos\n• ${chavesLimpas.length} categorias limpas\n• Sistema reinicializado\n\n✅ Você pode começar do ZERO agora!`;
            
            mostrarResultado(mensagem, 'success');
            
            // Auto-recarregar após 3 segundos
            setTimeout(() => {
                if (confirm('🔄 Deseja recarregar a aplicação agora para ver o sistema limpo?')) {
                    window.open('http://localhost:4173/', '_blank');
                }
            }, 3000);
        }

        function recarregarApp() {
            window.open('http://localhost:4173/', '_blank');
        }

        function mostrarResultado(mensagem, tipo) {
            const div = document.getElementById('resultado');
            div.className = `alert alert-${tipo}`;
            div.innerHTML = mensagem.replace(/\n/g, '<br>');
            div.style.display = 'block';
            
            // Scroll para o resultado
            div.scrollIntoView({ behavior: 'smooth' });
        }

        // Verificar dados automaticamente ao carregar
        window.onload = function() {
            verificarDados();
        };
    </script>
</body>
</html>